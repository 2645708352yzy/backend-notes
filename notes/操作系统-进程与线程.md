[[操作系统]]



## 进程与线程

### 进程

- 程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至 CPU，数据加载至内存。在指令运行过程中还需要用到磁盘 、网络等设备。进程就是用来加载指令、管理内存、管理 IO 的 。
- 当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。 
- 进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程（例如记事本、画图、浏览器等），也有的程序只能启动一个实例进程（例如网易云音乐、360 安全卫士等） 。
- 进程是一个程序在操作系统中的映射。

### 线程

- 一个进程之内可以分为一到多个线程。
- 一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给 CPU 执行 。
- Java 中，线程是最小的调度单位，进程作为资源分配的最小单位。 在 Windows 中进程是不活动的，只是作为线程的容器。

### 区别与联系

与进程不同的是同类的多个线程共享进程的堆和方法区资源，但每个线程有自己的程序计数器、虚拟机栈和本地方法栈，所以系统在产生一个线程，或是在各个线程之间做切换工作时，负担要比进程小得多，也正因为如此，线程也被称为轻量级进程。

### 进程与线程结构-AI解释

简单来说：
*   **进程 (Process)** 是**资源分配**的基本单位。它拥有独立的内存空间和系统资源。
*   **线程 (Thread)** 是**CPU调度和执行**的基本单位。它是进程内的一个执行流，共享进程的资源。

---

#### 一、 进程的结构

一个进程不仅仅是我们编写的代码，它是一个包含了程序代码、数据以及执行状态的**动态实体**。其核心结构通常包括以下几个部分：

1.  **进程控制块 (Process Control Block, PCB)**
    *   **这是进程存在的唯一标志**，也是操作系统感知和管理进程的核心数据结构。每个进程都有一个唯一的PCB。
    *   **主要内容包括：**
        *   **进程标识符 (PID)**： 唯一标识该进程的ID。
        *   **进程状态**： 如运行 (Running)、就绪 (Ready)、阻塞 (Blocked/Waiting) 等。
        *   **程序计数器 (PC / Instruction Pointer)**： 指向下一条要执行的指令的地址。
        *   **CPU寄存器状态**： 当进程被切换出去时，需要保存当前所有CPU寄存器的值（如通用寄存器、栈指针、状态寄存器等），以便下次恢复执行。
        *   **CPU调度信息**： 进程优先级、调度队列指针等。
        *   **内存管理信息**： 基址寄存器、界限寄存器的值，或指向页表/段表的指针，用于管理该进程的虚拟地址空间。
        *   **记账信息**： CPU使用时间、时间限制、进程号等，用于统计和计费。
        *   **I/O状态信息**： 分配给该进程的I/O设备列表、打开的文件列表等。

2.  **程序段 (Text Segment / Code Segment)**
    *   存放进程对应的**可执行机器指令**。通常是只读的，防止程序意外修改自身指令。

3.  **数据段 (Data Segment)**
    *   存放**全局变量和静态变量**。在程序编译时大小基本确定。

4.  **堆 (Heap)**
    *   用于**动态内存分配**（如C语言的 `malloc` / `free`， C++的 `new` / `delete`）。堆的大小在运行时可以动态增长或收缩，通常向上增长（向高地址）。

5.  **栈 (Stack)**
    *   用于存放**函数调用的上下文信息**，包括函数参数、局部变量、返回地址等。栈是后进先出 (LIFO) 结构，通常向下增长（向低地址）。**每个线程通常都有自己的独立栈**。

6.  **打开的文件描述符表 (Open File Descriptors)**
    *   记录进程当前打开的所有文件、网络套接字等I/O资源。

**总结进程结构的特点：**
*   **独立性**： 每个进程拥有自己独立的虚拟地址空间（代码、数据、堆、栈），一个进程的崩溃通常不会直接影响其他进程。
*   **资源拥有者**： 进程是系统资源（内存、文件、I/O设备等）的拥有者。
*   **开销大**： 创建、销毁和切换进程的开销相对较大，因为需要分配/回收资源、切换内存映射等。

---

#### 二、 线程的结构

线程是进程内部的执行单元。一个进程可以包含一个或多个线程，这些线程共享进程的绝大部分资源。

1.  **线程控制块 (Thread Control Block, TCB)**
    *   类似于PCB，是操作系统管理线程的核心数据结构。
    *   **主要内容包括：**
        *   **线程标识符 (TID)**： 唯一标识该线程的ID。
        *   **线程状态**： 如运行、就绪、阻塞等。
        *   **程序计数器 (PC)**： 指向该线程下一条要执行的指令。
        *   **寄存器集合**： 保存该线程的CPU寄存器状态。
        *   **栈指针 (Stack Pointer)**： 指向该线程**私有栈**的栈顶。
        *   **指向所属进程PCB的指针**： 表明该线程属于哪个进程。

2.  **线程私有栈 (Thread Stack)**
    *   **这是线程最重要的私有资源**。每个线程都有自己的栈，用于存储函数调用时的局部变量、参数和返回地址。这是保证线程间函数调用不互相干扰的关键。

3.  **共享的进程资源**
    *   **代码段**： 同一进程内的所有线程共享相同的代码。
    *   **数据段和堆**： 所有线程共享全局变量、静态变量和动态分配的堆内存。这是线程间通信最直接的方式，但也带来了数据竞争 (Data Race) 的风险，需要同步机制（如互斥锁、信号量）来保护。
    *   **打开的文件描述符**： 所有线程共享进程打开的文件和I/O资源。
    *   **信号处理程序、进程ID、用户ID、组ID等**。

**总结线程结构的特点：**
*   **轻量级**： 创建、销毁和切换线程的开销远小于进程，因为不需要分配新的地址空间和大量资源。
*   **资源共享**： 同一进程内的线程共享大部分资源（代码、数据、堆、文件等），通信方便（直接读写共享内存），但也需要小心处理同步问题。
*   **独立执行流**： 每个线程有自己的PC、寄存器和栈，可以独立调度和执行。
*   **依赖性**： 线程不能独立存在，必须隶属于某个进程。进程结束，其所有线程也随之结束。

---

#### 三、 进程与线程结构对比

| 特性              | 进程 (Process)                             | 线程 (Thread)                                 |
| :---------------- | :----------------------------------------- | :-------------------------------------------- |
| **资源分配**      | **基本单位**，拥有独立资源                 | **非基本单位**，共享所属进程的资源            |
| **执行单位**      | 不是直接的执行单位（由其线程执行）         | **基本单位**，是CPU调度和执行的对象           |
| **地址空间**      | **独立**的虚拟地址空间                     | **共享**所属进程的地址空间                    |
| **私有资源**      | PCB、独立的代码/数据/堆/栈、文件描述符表   | **TCB、私有栈**、寄存器状态、程序计数器       |
| **共享资源**      | 无（进程间通信需特殊机制）                 | 代码段、数据段、堆、文件描述符、信号处理等    |
| **创建/切换开销** | **大**（涉及资源分配和地址空间切换）       | **小**（主要切换TCB和栈指针）                 |
| **通信方式**      | 复杂（管道、消息队列、共享内存、套接字等） | 简单（直接读写共享的全局变量/堆内存，需同步） |
| **健壮性**        | **高**，一个进程崩溃不影响其他进程         | **低**，一个线程崩溃可能导致整个进程崩溃      |
| **并发性**        | 进程间并发                                 | 进程内线程间并发，也可跨进程并发              |

---

#### 四、 一个形象的比喻

可以把**进程**想象成一个**工厂**：
*   工厂有自己独立的厂房（地址空间）、原材料仓库（堆）、设计图纸（代码段）、生产记录（数据段）、以及一个总管理办公室（PCB）。

**线程**则像是工厂里的**工人**：
*   每个工人（线程）有自己的工作台和工具箱（私有栈），他们共享同一个厂房、图纸、仓库和原材料。
*   工人们（线程）可以并行工作，共同完成生产任务（进程的目标）。
*   如果一个工人（线程）操作失误搞砸了共享的原材料（全局变量），可能会影响其他工人的工作，甚至导致整个工厂（进程）停产。
*   调度器（操作系统）决定哪个工人（线程）在哪个时间点使用机器（CPU）。

## **并行与并发**

### **并发**

单核 CPU 下，线程实际还是 串行执行 的。操作系统中有一个组件叫做任务调度器，将 CPU 的时间片（windows 下时间片最小约为 15 毫秒）分给不同的程序使用，只是由于 CPU 在线程间（时间片很短）的切换非常快，人类感觉是同时运行的 。总结为一句话就是： 微观串行，宏观并行 。

从使用者的角度观察，多个任务在同时进行。

### **并行**

多核 cpu下，每个核（core）都可以调度运行线程，这时候线程可以是 并行 的。

## 线程的基本应用

#### **异步调用**

从方法调用方的角度来讲，如果：

- 需要等待结果返回，才能继续运行就是同步
- 不需要等待结果返回，就能继续运行就是异步