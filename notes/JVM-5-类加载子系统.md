[[JVM]]

> Java 的类加载子系统是 JVM（Java 虚拟机）中负责加载、连接和初始化类的核心模块。它的主要任务是将 `.class` 文件加载到内存中，并将其转换为 JVM 可以理解的运行时数据结构。

![image-20250516172227682](JVM-5-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F.assets/image-20250516172227682.png)

### 方法区

方法区包含4类信息：

- 类的元数据，包括类的结构信息、访问权限、字段和方法等。
- 静态变量，类的静态变量，即在类级别共享的变量。
- 类的方法信息、构造函数。
- 最后是运行时常量池，它是一种存储编译时常量和引用的数据结构，主要包括字符串常量、数值常量、类引用、字段引用、方法引用等。运行时常量池在类被加载时自动创建，并在运行时被 JVM 使用。

#### 1. 类的元数据

**描述**：
类的元数据包括类的结构信息（如类名、父类名、接口信息）、访问权限（如 `public`、`private`）、字段和方法的定义等。

**实例**：
假设有一个简单的 Java 类：

```java
public class Person {
    private String name;
    private int age;

    public void sayHello() {
        System.out.println("Hello, my name is " + name);
    }
}
```

在方法区中，`Person` 类的元数据会存储以下信息：

- 类名：`Person`
- 父类名：`java.lang.Object`
- 字段：`name`（类型为 `String`）、`age`（类型为 `int`）
- 方法：`sayHello()`（方法签名和访问权限）

这些信息在类加载时由 JVM 加载到方法区中，供运行时使用。

#### 2. 静态变量

**描述**：
静态变量是类级别的变量，属于类本身而不是某个实例。它们在方法区中存储，并在类加载时初始化。

**实例**：

```java
public class Counter {
    public static int count = 0;

    public Counter() {
        count++;
    }
}
```

在方法区中，`count` 是一个静态变量，存储在方法区中。无论创建多少个 `Counter` 实例，`count` 的值都是共享的。例如：

```java
Counter c1 = new Counter(); // count = 1
Counter c2 = new Counter(); // count = 2
```

#### 3. 类的方法信息和构造函数

**描述**：
方法区存储类的方法字节码（包括普通方法和构造函数），供 JVM 执行时调用。

**实例**：
对于 `Person` 类中的 `sayHello()` 方法，方法区会存储其字节码表示。JVM 在运行时会从方法区中读取字节码并执行。

构造函数的字节码也存储在方法区中。例如：

```java
public Person(String name, int age) {
    this.name = name;
    this.age = age;
}
```

这个构造函数的字节码会被加载到方法区中，供 JVM 在创建 `Person` 对象时调用。



### 类加载流程

![图片](JVM-5-%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F.assets/398c340be2b9b1db2d44bfae86e51ccc.png)

#### 加载

- 查找：第一步就是通过一组预先定义的类加载器进行类的查找，帮助用户快速、准确地搜索到所需的二进制字节流。
- 转化：JVM在收集到类的二进制信息之后，必须把这些信息转换成一种可以在任何情况下执行的实体模型。在这个转化过程中，JVM将字节流所代表的静态存储结构转换成方法区里的运行时数据结构，也就是类的信息、静态变量、常量等数据，以便后续执行和访问。
- 生成：JVM将一个特定的java.lang.Class映射到Java堆，以此来提供一个可以访问这个类的入口。

#### 连接

- 验证阶段：确保被加载的类是正确且安全的。
  - 字节码验证：对字节码进行静态分析，确保程序的处理逻辑是正确的。
  - 符号引用验证：检查字节码中的符号名称，确保它们能够被正确地解析，从而确保类、方法和方法之间的调用关系是正确的，确保解析动作的准确性和可靠性。
- 准备阶段：给类中的静态变量分配空间，并且设置一个初值。
  - 静态变量，在这个阶段会进行内存的分配，意味着这个变量是属于整个类的，不依赖于任何对象实例。相对的，对于实例变量来说，它们是在创建对象的过程中在Java的堆内存中分配的。
  - 静态变量的初值通常会被设置成这个数据类型的默认值。
- 解析阶段：
  - JVM把类文件中的符号引用改为直接引用的过程。

#### 初始化

- JVM会执行类的初始化代码，并同步多个线程对同一个类的初始化。类的静态变量的初始化可以在声明时指定初始值，或者在静态代码块中进行。初始化过程会按顺序执行初始化语句，如果类或其父类还未加载和连接，则先进行加载和连接。

> **补充：类加载中的锁机制**
>
> &emsp;为了确保 Java 类的全局唯一性和线程安全，类加载器在加载类的时候使用了锁机制。当多个线程尝试同时加载同一个类时，只有一个线程可以获得类加载的锁，其他线程需要等待，直到那个线程完成类加载操作。